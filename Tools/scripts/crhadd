#!/usr/bin/env python

import os, glob, sys, JMTucker.Tools.argparse as argparse
from JMTucker.Tools.CRABTools import is_crab_working_dir, crab_hadd

parser = argparse.ArgumentParser(description = 'crhadd: hadd the files from a crab directory',
                                 usage = '%(prog)s [options] crab_dirs')

parser.add_argument('positional', nargs='*', help='The crab directories.')

parser.add_argument('--chunk-size', default=900,
                    help='The maximum number files hadded at once.')

options = parser.parse_args()

if len(options.positional) == 0:
    print 'Required positional args missing: at least one crab directory\n'
    parser.print_help()
    sys.exit(1)
    
########################################################################

crab_dirs = options.positional

for x in crab_dirs:
    if is_crab_working_dir(x):
        crab_hadd(x, chunk_size=options.chunk_size)
    elif os.path.isdir(x):
        # if we have a dir of crab dirs, make a new dir of the same
        # name and haddcrab all their files into it.
        sub_dirs = [d for d in glob.glob(os.path.join(x, '*')) if os.path.isdir(d)]
        new_dir = os.path.basename(x)
        os.system('mkdir -p %s' % new_dir)
        for y in sub_dirs:
            crab_hadd(y, new_dir=new_dir, chunk_size=options.chunk_size)
